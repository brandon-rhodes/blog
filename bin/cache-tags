#!/usr/bin/env python

import datetime
import os
import re
import sys
from docutils.core import publish_parts
from pprint import pformat

overrides = {'initial_header_level': 2}

def main():
    input_paths = sys.argv[1:-1]
    output_path = sys.argv[-1]

    info_list = []
    for input_path in input_paths:
        with open(input_path) as f:
            info = eval(f.read())
            if 'date' not in info:
                sys.stderr.write('{}: missing date\n'.format(input_path))
                sys.exit(1)
            info_list.append(info)
    info_list.sort(key=lambda i: i['date'])

    pairs = [(tag, info['path']) for info in info_list for tag in info['tags']]
    tags = set(tag for tag, path in pairs)

    with open(output_path, 'w') as f:
        for tag, path in sorted(pairs):
            f.write('# {} {}\n'.format(tag, path))
        f.write('\n')
        for tag in sorted(tags):
            f.write('tags += {}\n'.format(tag))

if __name__ == '__main__':
    main()
